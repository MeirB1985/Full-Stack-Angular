{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/user/Desktop/FullStack/JB/Third Project/fe/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport CartModel from 'src/app/models/cart.model';\nimport ItemModel from 'src/app/models/item.model';\nimport store from 'src/app/redux/store';\nimport { environment } from 'src/environments/environment';\nimport { DialogComponent } from '../dialog/dialog.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/services/carts.service\";\nimport * as i2 from \"src/app/services/orders.service\";\nimport * as i3 from \"src/app/services/items.service\";\nimport * as i4 from \"src/app/services/notify.service\";\nimport * as i5 from \"@angular/material/dialog\";\nexport class ProductCardComponent {\n  constructor(myCartsService, myOrdersService, myItemsService, notify, dialog) {\n    this.myCartsService = myCartsService;\n    this.myOrdersService = myOrdersService;\n    this.myItemsService = myItemsService;\n    this.notify = notify;\n    this.dialog = dialog;\n    this.item = new ItemModel();\n    this.imageUrl = environment.productImagesUrl;\n  } // ngOnInit(): void {\n  //   this.unsubscribeMe = store.subscribe(() => {\n  //       this.user = store.getState().authState.user;\n  //   });\n  // }\n  // ngOnDestroy(): void {\n  //     this.unsubscribeMe();\n  // }\n\n\n  openDialog() {\n    var _this = this;\n\n    this.unsubscribeMe = store.subscribe( /*#__PURE__*/_asyncToGenerator(function* () {\n      _this.user = store.getState().authState.user;\n\n      if (_this.user.admin === true) {\n        console.log(\"admin\");\n      } // else {\n      //   try {\n      //     this.carts = await this.myCartsService.getAllCarts(this.user._id);\n      //   }\n      //   catch (err) {\n      //     console.log(\"err getting user carts\");\n      //   }\n      // }  \n\n    }));\n    let dialogRef = this.dialog.open(DialogComponent, {\n      data: {\n        product: this.product,\n        quantity: this.quantity\n      }\n    }); // }\n\n    dialogRef.afterClosed().subscribe( /*#__PURE__*/function () {\n      var _ref2 = _asyncToGenerator(function* (result) {\n        _this.user = store.getState().authState.user;\n\n        try {\n          _this.carts = yield _this.myCartsService.getAllCarts(_this.user._id);\n        } catch (err) {\n          console.log(\"err getting user carts\");\n        }\n\n        console.log('The dialog was closed');\n        console.log(_this.carts);\n        _this.quantity = result; // find out if user have an open cart or not\n\n        if (_this.carts === undefined) {\n          console.log(\"carts null\"); // there is no cart for this user-create one\n\n          _this.createCartAndAddItem();\n        } else {\n          try {\n            _this.orders = yield _this.myOrdersService.getAllUserOrders(_this.user._id);\n          } catch (err) {\n            console.log(\"err getting user orders\");\n          } // find out if user have some old order\n\n\n          if (_this.orders === undefined) {\n            console.log(\"there is an open cart for this user, but no orders in\"); // this.lastCartIndex = this.carts.length - 1;\n            // this.item.cart = this.carts[this.lastCartIndex];\n            // there is an open cart for this user, but no orders in it-add items to it\n\n            _this.addItemToOpenCart();\n          } else {\n            // this user have cart and order, check if he has an open cart or not\n            _this.lastCartIndex = _this.carts.length - 1;\n            _this.lastOrderIndex = _this.orders.length - 1;\n\n            if (_this.carts[_this.lastCartIndex]._id === _this.orders[_this.lastOrderIndex].cart._id) {\n              console.log(\"user closed his last cart\"); // the user closed his last cart-create new one for him\n\n              _this.createCartAndAddItem();\n            } else {\n              console.log(\"there is an open cart\");\n              _this.lastCartIndex = _this.carts.length - 1;\n              _this.item.cart = _this.carts[_this.lastCartIndex]; // add item to user's new cart\n\n              _this.addItemToOpenCart();\n            }\n          }\n        }\n      });\n\n      return function (_x) {\n        return _ref2.apply(this, arguments);\n      };\n    }()); // }\n    // });\n  }\n\n  createCartAndAddItem() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.user = store.getState().authState.user;\n      _this2.newCart = new CartModel();\n      _this2.newCart.user = _this2.user;\n      _this2.newCart.date = new Date().toDateString();\n\n      try {\n        _this2.newCart = yield _this2.myCartsService.addCart(_this2.newCart);\n      } catch (err) {\n        console.log(\"problem creating cart\");\n      }\n\n      _this2.item = new ItemModel();\n      console.log(_this2.newCart._id);\n      _this2.item.cart = _this2.newCart;\n      _this2.item.product = _this2.product;\n      _this2.item.quantity = _this2.quantity;\n      _this2.item.price = _this2.product.price * _this2.quantity;\n\n      try {\n        _this2.item = yield _this2.myItemsService.addItem(_this2.item);\n      } catch (err) {\n        console.log(\"problem adding item to cart\");\n      }\n    })();\n  }\n\n  addItemToOpenCart() {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      _this3.item = new ItemModel();\n      console.log(\"there's an open cart\");\n      _this3.lastCartIndex = _this3.carts.length - 1;\n      _this3.item.cart = _this3.carts[_this3.lastCartIndex];\n      console.log(_this3.item.cart);\n      _this3.item.product = _this3.product; // console.log(this.item.product); works\n\n      _this3.item.quantity = _this3.quantity;\n      _this3.item.price = _this3.product.price * _this3.quantity;\n\n      try {\n        _this3.item = yield _this3.myItemsService.addItem(_this3.item);\n      } catch (err) {\n        console.log(\"problem adding item to cart\");\n      }\n\n      console.log(_this3.item);\n    })();\n  }\n\n  editProduct() {\n    if (this.user.admin === false) {\n      console.log(\"user\");\n    } else {}\n  }\n\n}\n\nProductCardComponent.ɵfac = function ProductCardComponent_Factory(t) {\n  return new (t || ProductCardComponent)(i0.ɵɵdirectiveInject(i1.CartsService), i0.ɵɵdirectiveInject(i2.OrdersService), i0.ɵɵdirectiveInject(i3.ItemsService), i0.ɵɵdirectiveInject(i4.NotifyService), i0.ɵɵdirectiveInject(i5.MatDialog));\n};\n\nProductCardComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: ProductCardComponent,\n  selectors: [[\"app-product-card\"]],\n  inputs: {\n    product: \"product\"\n  },\n  decls: 6,\n  vars: 3,\n  consts: [[\"mat-raised-button\", \"\", 3, \"click\"], [3, \"src\"]],\n  template: function ProductCardComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0);\n      i0.ɵɵlistener(\"click\", function ProductCardComponent_Template_div_click_0_listener() {\n        return ctx.openDialog();\n      });\n      i0.ɵɵtext(1);\n      i0.ɵɵelement(2, \"br\");\n      i0.ɵɵtext(3);\n      i0.ɵɵelement(4, \"br\");\n      i0.ɵɵelement(5, \"img\", 1);\n      i0.ɵɵelementEnd();\n    }\n\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵtextInterpolate1(\" \", ctx.product.name, \" \");\n      i0.ɵɵadvance(2);\n      i0.ɵɵtextInterpolate1(\" Price: \", ctx.product.price, \" \");\n      i0.ɵɵadvance(2);\n      i0.ɵɵproperty(\"src\", ctx.imageUrl + ctx.product.imageName, i0.ɵɵsanitizeUrl);\n    }\n  },\n  styles: [\"div[_ngcontent-%COMP%] {\\r\\n\\twidth: 100px;\\r\\n    height: 100px;\\r\\n    display: inline-block;\\r\\n    text-align: left;\\r\\n    align-items: center;\\r\\n    \\r\\n    padding: 0 10px;\\r\\n    margin: 10px;\\r\\n}\\r\\n\\r\\nimg[_ngcontent-%COMP%] {\\r\\n    width: 60px;\\r\\n    height: 60px;\\r\\n    margin: 5px;\\r\\n    \\r\\n    \\r\\n}\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2R1Y3QtY2FyZC5jb21wb25lbnQuY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0NBQ0MsWUFBWTtJQUNULGFBQWE7SUFDYixxQkFBcUI7SUFDckIsZ0JBQWdCO0lBQ2hCLG1CQUFtQjtJQUNuQixpRUFBaUU7SUFDakUsZUFBZTtJQUNmLFlBQVk7QUFDaEI7O0FBRUE7SUFDSSxXQUFXO0lBQ1gsWUFBWTtJQUNaLFdBQVc7SUFDWDs4QkFDMEI7SUFDMUIsNEJBQTRCO0FBQ2hDOztBQUVBOztHQUVHIiwiZmlsZSI6InByb2R1Y3QtY2FyZC5jb21wb25lbnQuY3NzIiwic291cmNlc0NvbnRlbnQiOlsiZGl2IHtcclxuXHR3aWR0aDogMTAwcHg7XHJcbiAgICBoZWlnaHQ6IDEwMHB4O1xyXG4gICAgZGlzcGxheTogaW5saW5lLWJsb2NrO1xyXG4gICAgdGV4dC1hbGlnbjogbGVmdDtcclxuICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7XHJcbiAgICAvKiBiYWNrZ3JvdW5kLWltYWdlOiBsaW5lYXItZ3JhZGllbnQoNDVkZWcsIGxpZ2h0Z3JlZW4sIHdoaXRlKTsgKi9cclxuICAgIHBhZGRpbmc6IDAgMTBweDtcclxuICAgIG1hcmdpbjogMTBweDtcclxufVxyXG5cclxuaW1nIHtcclxuICAgIHdpZHRoOiA2MHB4O1xyXG4gICAgaGVpZ2h0OiA2MHB4O1xyXG4gICAgbWFyZ2luOiA1cHg7XHJcbiAgICAvKiBib3JkZXItcmFkaXVzOiAxMHB4O1xyXG4gICAgYm9yZGVyOiAxcHggc29saWQgYmxhY2s7ICovXHJcbiAgICAvKiB2ZXJ0aWNhbC1hbGlnbjogbWlkZGxlOyAqL1xyXG59XHJcblxyXG4vKiBhIHtcclxuICAgIG1hcmdpbi1sZWZ0OiBhdXRvO1xyXG59ICovIl19 */\"]\n});","map":{"version":3,"sources":["C:\\Users\\user\\Desktop\\FullStack\\JB\\Third Project\\fe\\src\\app\\components\\products-area\\product-card\\product-card.component.ts","C:\\Users\\user\\Desktop\\FullStack\\JB\\Third Project\\fe\\src\\app\\components\\products-area\\product-card\\product-card.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, Input, OnInit } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport { Unsubscribe } from 'redux';\nimport CartModel from 'src/app/models/cart.model';\nimport ItemModel from 'src/app/models/item.model';\nimport OrderModel from 'src/app/models/order.model';\nimport ProductModel from 'src/app/models/product.model';\nimport UserModel from 'src/app/models/user.model';\nimport store from 'src/app/redux/store';\nimport { CartsService } from 'src/app/services/carts.service';\nimport { ItemsService } from 'src/app/services/items.service';\nimport { NotifyService } from 'src/app/services/notify.service';\nimport { OrdersService } from 'src/app/services/orders.service';\nimport { environment } from 'src/environments/environment';\nimport { DialogComponent } from '../dialog/dialog.component';\n\nexport interface DialogData {\n  product: ProductModel;\n  price: number;\n  name: string;\n  imageName: string;\n  quantity: number;\n}\n\n@Component({\n    selector: 'app-product-card',\n    templateUrl: './product-card.component.html',\n    styleUrls: ['./product-card.component.css']\n})\nexport class ProductCardComponent {\n\n  public user: UserModel;\n  private unsubscribeMe: Unsubscribe;\n  \n  @Input()\n  public product: ProductModel;\n\n  public item = new ItemModel();\n  public orders: OrderModel[];\n  public imageUrl = environment.productImagesUrl;\n  private carts: CartModel[];\n  private newCart: CartModel;\n  private cart: CartModel;\n  private lastCartIndex: number;\n  private lastOrderIndex: number;\n  public quantity: number;\n\n  constructor (\n      private myCartsService: CartsService,\n      private myOrdersService: OrdersService,\n      private myItemsService: ItemsService,\n      private notify: NotifyService,\n      public dialog: MatDialog\n  ) {}\n\n  // ngOnInit(): void {\n  //   this.unsubscribeMe = store.subscribe(() => {\n  //       this.user = store.getState().authState.user;\n  //   });\n  // }\n\n  // ngOnDestroy(): void {\n  //     this.unsubscribeMe();\n  // }\n\n  openDialog() {\n    this.unsubscribeMe = store.subscribe(async () => {\n      this.user = store.getState().authState.user;\n      if (this.user.admin === true) {\n        console.log(\"admin\");\n      } \n      // else {\n      //   try {\n      //     this.carts = await this.myCartsService.getAllCarts(this.user._id);\n      //   }\n      //   catch (err) {\n      //     console.log(\"err getting user carts\");\n      //   }\n      // }  \n    });\n        let dialogRef = this.dialog.open(DialogComponent, {\n          data: {product: this.product, quantity: this.quantity},\n        });\n      // }\n\n        dialogRef.afterClosed().subscribe( async result => {\n          this.user = store.getState().authState.user;\n          try {\n            this.carts = await this.myCartsService.getAllCarts(this.user._id);\n          }\n          catch (err) {\n            console.log(\"err getting user carts\");\n          }\n          console.log('The dialog was closed');\n          console.log(this.carts);\n          this.quantity = result;\n          // find out if user have an open cart or not\n          if (this.carts === undefined){\n            console.log(\"carts null\");\n            // there is no cart for this user-create one\n            this.createCartAndAddItem();\n          } else {\n            try {\n              this.orders = await this.myOrdersService.getAllUserOrders(this.user._id);\n            }\n            catch (err) {\n              console.log(\"err getting user orders\");\n            }\n            // find out if user have some old order\n            if (this.orders === undefined) {\n              console.log(\"there is an open cart for this user, but no orders in\");\n              // this.lastCartIndex = this.carts.length - 1;\n              // this.item.cart = this.carts[this.lastCartIndex];\n              // there is an open cart for this user, but no orders in it-add items to it\n              this.addItemToOpenCart();\n            } else {\n              // this user have cart and order, check if he has an open cart or not\n              this.lastCartIndex = this.carts.length - 1;\n              this.lastOrderIndex = this.orders.length - 1;\n              if (this.carts[this.lastCartIndex]._id === this.orders[this.lastOrderIndex].cart._id) {\n                console.log(\"user closed his last cart\");\n                // the user closed his last cart-create new one for him\n                this.createCartAndAddItem(); \n              } else {\n                console.log(\"there is an open cart\")\n                this.lastCartIndex = this.carts.length - 1;\n                this.item.cart = this.carts[this.lastCartIndex];\n                // add item to user's new cart\n                this.addItemToOpenCart();\n              }\n            }\n          }\n        });\n      // }\n    // });\n  }\n\n  async createCartAndAddItem() {\n    this.user = store.getState().authState.user;\n    this.newCart = new CartModel();\n    this.newCart.user = this.user;\n    this.newCart.date = new Date().toDateString();\n    try {\n      this.newCart = await this.myCartsService.addCart(this.newCart);\n    }\n    catch (err) {\n      console.log(\"problem creating cart\");\n    }\n    this.item = new ItemModel();\n    console.log(this.newCart._id);\n    this.item.cart = this.newCart;\n    this.item.product = this.product;\n    this.item.quantity = this.quantity;\n    this.item.price = this.product.price*this.quantity;\n    try {\n      this.item = await this.myItemsService.addItem(this.item);\n    }\n    catch (err) {\n          console.log(\"problem adding item to cart\");\n    }\n  }\n\n  async addItemToOpenCart() {\n    this.item = new ItemModel();\n    console.log(\"there's an open cart\");\n    this.lastCartIndex = this.carts.length -1;\n    this.item.cart = this.carts[this.lastCartIndex];\n    console.log(this.item.cart);\n    this.item.product = this.product;\n    // console.log(this.item.product); works\n    this.item.quantity = this.quantity;\n    this.item.price = this.product.price*this.quantity;\n    try {\n      this.item = await this.myItemsService.addItem(this.item);\n    }\n    catch (err) {\n          console.log(\"problem adding item to cart\");\n    }\n    console.log(this.item)\n  }\n\n  editProduct() {\n    if (this.user.admin===false) {\n      console.log(\"user\");\n    } else {\n      \n    }\n  }\n}\n\n\n","<div mat-raised-button (click)=\"openDialog()\">\n    {{product.name}}\n    <br />\n    Price: {{product.price}}\n    <br />\n    <img [src]=\"imageUrl + product.imageName\"/>\n</div>\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}