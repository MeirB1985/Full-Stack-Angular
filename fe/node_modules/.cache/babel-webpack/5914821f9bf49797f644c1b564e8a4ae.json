{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/user/Desktop/FullStack/JB/ThirdProject/fe/node_modules/@angular-devkit/build-angular/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport CartModel from 'src/app/models/cart.model';\nimport ItemModel from 'src/app/models/item.model';\nimport store from 'src/app/redux/store';\nimport { environment } from 'src/environments/environment';\nimport { DialogComponent } from '../dialog/dialog.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/services/carts.service\";\nimport * as i2 from \"src/app/services/orders.service\";\nimport * as i3 from \"src/app/services/items.service\";\nimport * as i4 from \"src/app/services/products.service\";\nimport * as i5 from \"@angular/router\";\nimport * as i6 from \"src/app/services/category.service\";\nimport * as i7 from \"@angular/material/dialog\";\nexport class ProductCardComponent {\n  constructor(myCartsService, myOrdersService, myItemsService, myProductsService, myActivatedRoute, myCategoriesService, dialog) {\n    this.myCartsService = myCartsService;\n    this.myOrdersService = myOrdersService;\n    this.myItemsService = myItemsService;\n    this.myProductsService = myProductsService;\n    this.myActivatedRoute = myActivatedRoute;\n    this.myCategoriesService = myCategoriesService;\n    this.dialog = dialog;\n    this.item = new ItemModel();\n    this.imageUrl = environment.productImagesUrl;\n  }\n\n  ngOnInit() {\n    var _this = this;\n\n    return _asyncToGenerator(function* () {\n      try {\n        const id = _this.myActivatedRoute.snapshot.params.id;\n        _this.category = yield _this.myCategoriesService.getOneCategory(id);\n      } catch (err) {\n        console.log(err);\n      }\n\n      try {\n        _this.categories = yield _this.myCategoriesService.getAllCategories();\n      } catch (err) {\n        console.log(err);\n      }\n    })();\n  }\n\n  openDialog() {\n    var _this2 = this;\n\n    return _asyncToGenerator(function* () {\n      _this2.user = store.getState().authState.user;\n\n      if (_this2.user.admin === true) {} else {\n        try {\n          _this2.carts = yield _this2.myCartsService.getAllCarts(_this2.user._id);\n        } catch (err) {\n          console.log(\"err getting user carts\");\n        }\n\n        console.log('The dialog was closed');\n\n        let dialogRef = _this2.dialog.open(DialogComponent, {\n          data: {\n            quantity: _this2.quantity,\n            product: _this2.product\n          }\n        });\n\n        dialogRef.afterClosed().subscribe( /*#__PURE__*/function () {\n          var _ref = _asyncToGenerator(function* (result) {\n            _this2.quantity = result; // find out if user have an open cart or not\n\n            if (_this2.carts === undefined || _this2.carts === null) {\n              console.log(\"carts null\"); // there is no cart for this user-create one\n\n              _this2.createCartAndAddItem();\n            } else {\n              try {\n                _this2.orders = yield _this2.myOrdersService.getAllUserOrders(_this2.user._id);\n              } catch (err) {\n                console.log(\"err getting user orders\");\n              } // find out if user have some old order\n\n\n              if (_this2.orders === undefined || _this2.orders === null) {\n                // there is an open cart for this user, but no orders in it-add items to it\n                _this2.addItemToOpenCart();\n              } else {\n                // this user have cart and order, check if he has an open cart or not\n                _this2.lastCartIndex = _this2.carts.length - 1;\n                _this2.lastOrderIndex = _this2.orders.length - 1;\n\n                if (_this2.carts[_this2.lastCartIndex]._id === _this2.orders[_this2.lastOrderIndex].cart._id) {\n                  // the user closed his last cart-create new one for him\n                  _this2.createCartAndAddItem();\n                } else {\n                  console.log(\"there is an open cart\");\n                  _this2.lastCartIndex = _this2.carts.length - 1;\n                  _this2.item.cart = _this2.carts[_this2.lastCartIndex]; // add item to user's new cart\n\n                  _this2.addItemToOpenCart();\n                }\n              }\n            }\n          });\n\n          return function (_x) {\n            return _ref.apply(this, arguments);\n          };\n        }());\n      }\n    })();\n  }\n\n  createCartAndAddItem() {\n    var _this3 = this;\n\n    return _asyncToGenerator(function* () {\n      _this3.user = store.getState().authState.user;\n      _this3.newCart = new CartModel();\n      _this3.newCart.user = _this3.user;\n      _this3.newCart.date = new Date().toDateString();\n\n      try {\n        _this3.newCart = yield _this3.myCartsService.addCart(_this3.newCart);\n      } catch (err) {\n        console.log(\"problem creating cart\");\n      }\n\n      _this3.item = new ItemModel();\n      _this3.item.cart = _this3.newCart;\n      _this3.item.product = _this3.product;\n      _this3.item.quantity = _this3.quantity;\n      _this3.item.price = _this3.product.price * _this3.quantity;\n\n      try {\n        _this3.item = yield _this3.myItemsService.addItem(_this3.item);\n\n        _this3.myProductsService.updateCart(true);\n      } catch (err) {\n        console.log(\"problem adding item to cart\");\n      }\n    })();\n  }\n\n  addItemToOpenCart() {\n    var _this4 = this;\n\n    return _asyncToGenerator(function* () {\n      _this4.item = new ItemModel();\n      _this4.lastCartIndex = _this4.carts.length - 1;\n      _this4.item.cart = _this4.carts[_this4.lastCartIndex];\n      _this4.item.product = _this4.product;\n      _this4.item.quantity = _this4.quantity;\n      _this4.item.price = _this4.product.price * _this4.quantity;\n\n      try {\n        _this4.item = yield _this4.myItemsService.addItem(_this4.item);\n\n        _this4.myProductsService.updateCart(true);\n      } catch (err) {\n        console.log(\"problem adding item to cart\");\n      }\n    })();\n  }\n\n}\n\nProductCardComponent.ɵfac = function ProductCardComponent_Factory(t) {\n  return new (t || ProductCardComponent)(i0.ɵɵdirectiveInject(i1.CartsService), i0.ɵɵdirectiveInject(i2.OrdersService), i0.ɵɵdirectiveInject(i3.ItemsService), i0.ɵɵdirectiveInject(i4.ProductsService), i0.ɵɵdirectiveInject(i5.ActivatedRoute), i0.ɵɵdirectiveInject(i6.CategoryService), i0.ɵɵdirectiveInject(i7.MatDialog));\n};\n\nProductCardComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: ProductCardComponent,\n  selectors: [[\"app-product-card\"]],\n  inputs: {\n    product: \"product\",\n    category: \"category\"\n  },\n  decls: 6,\n  vars: 3,\n  consts: [[\"mat-raised-button\", \"\", 3, \"click\"], [3, \"src\"]],\n  template: function ProductCardComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0);\n      i0.ɵɵlistener(\"click\", function ProductCardComponent_Template_div_click_0_listener() {\n        return ctx.openDialog();\n      });\n      i0.ɵɵtext(1);\n      i0.ɵɵelement(2, \"br\");\n      i0.ɵɵtext(3);\n      i0.ɵɵelement(4, \"br\");\n      i0.ɵɵelement(5, \"img\", 1);\n      i0.ɵɵelementEnd();\n    }\n\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵtextInterpolate1(\" \", ctx.product.name, \" \");\n      i0.ɵɵadvance(2);\n      i0.ɵɵtextInterpolate1(\" Price: \", ctx.product.price, \" \");\n      i0.ɵɵadvance(2);\n      i0.ɵɵproperty(\"src\", ctx.imageUrl + ctx.product.imageName, i0.ɵɵsanitizeUrl);\n    }\n  },\n  styles: [\"div[_ngcontent-%COMP%] {\\r\\n\\twidth: 100px;\\r\\n    height: 100px;\\r\\n    display: inline-block;\\r\\n    text-align: center;\\r\\n    align-items: center;\\r\\n    padding: 0 10px;\\r\\n}\\r\\n\\r\\nimg[_ngcontent-%COMP%] {\\r\\n    width: 60px;\\r\\n    height: 60px;\\r\\n    margin: 5px;\\r\\n}\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByb2R1Y3QtY2FyZC5jb21wb25lbnQuY3NzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0NBQ0MsWUFBWTtJQUNULGFBQWE7SUFDYixxQkFBcUI7SUFDckIsa0JBQWtCO0lBQ2xCLG1CQUFtQjtJQUNuQixlQUFlO0FBQ25COztBQUVBO0lBQ0ksV0FBVztJQUNYLFlBQVk7SUFDWixXQUFXO0FBQ2YiLCJmaWxlIjoicHJvZHVjdC1jYXJkLmNvbXBvbmVudC5jc3MiLCJzb3VyY2VzQ29udGVudCI6WyJkaXYge1xyXG5cdHdpZHRoOiAxMDBweDtcclxuICAgIGhlaWdodDogMTAwcHg7XHJcbiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XHJcbiAgICB0ZXh0LWFsaWduOiBjZW50ZXI7XHJcbiAgICBhbGlnbi1pdGVtczogY2VudGVyO1xyXG4gICAgcGFkZGluZzogMCAxMHB4O1xyXG59XHJcblxyXG5pbWcge1xyXG4gICAgd2lkdGg6IDYwcHg7XHJcbiAgICBoZWlnaHQ6IDYwcHg7XHJcbiAgICBtYXJnaW46IDVweDtcclxufSJdfQ== */\"]\n});","map":{"version":3,"sources":["C:\\Users\\user\\Desktop\\FullStack\\JB\\ThirdProject\\fe\\src\\app\\components\\products-area\\product-card\\product-card.component.ts","C:\\Users\\user\\Desktop\\FullStack\\JB\\ThirdProject\\fe\\src\\app\\components\\products-area\\product-card\\product-card.component.html"],"names":[],"mappings":"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","sourcesContent":["import { Component, Input, OnInit } from '@angular/core';\nimport { MatDialog } from '@angular/material/dialog';\nimport { ActivatedRoute } from '@angular/router';\nimport { Unsubscribe } from 'redux';\nimport CartModel from 'src/app/models/cart.model';\nimport CategoryModel from 'src/app/models/category.model';\nimport ItemModel from 'src/app/models/item.model';\nimport OrderModel from 'src/app/models/order.model';\nimport ProductModel from 'src/app/models/product.model';\nimport UserModel from 'src/app/models/user.model';\nimport store from 'src/app/redux/store';\nimport { CartsService } from 'src/app/services/carts.service';\nimport { CategoryService } from 'src/app/services/category.service';\nimport { ItemsService } from 'src/app/services/items.service';\nimport { OrdersService } from 'src/app/services/orders.service';\nimport { ProductsService } from 'src/app/services/products.service';\nimport { environment } from 'src/environments/environment';\nimport { DialogComponent } from '../dialog/dialog.component';\n\nexport interface DialogData {\n  product: ProductModel;\n  quantity: number;\n}\n\n@Component({\n    selector: 'app-product-card',\n    templateUrl: './product-card.component.html',\n    styleUrls: ['./product-card.component.css']\n})\n\nexport class ProductCardComponent {\n\n  @Input()\n  public product: ProductModel;\n\n  @Input()\n  public category: CategoryModel;\n\n  public user: UserModel;\n  public products: ProductModel[];\n  public item = new ItemModel();\n  public items: ItemModel[];\n  public orders: OrderModel[];\n  public imageUrl = environment.productImagesUrl;\n  private carts: CartModel[];\n  private newCart: CartModel;\n  public categories: CategoryModel[];\n  private lastCartIndex: number;\n  private lastOrderIndex: number;\n  public quantity: number;\n\n  constructor (\n    private myCartsService: CartsService,\n    private myOrdersService: OrdersService,\n    private myItemsService: ItemsService,\n    private myProductsService: ProductsService,\n    private myActivatedRoute: ActivatedRoute,\n    private myCategoriesService: CategoryService,\n    public dialog: MatDialog\n  ) {}\n\n  async ngOnInit() {\n    try {\n      const id = this.myActivatedRoute.snapshot.params.id;\n      this.category = await this.myCategoriesService.getOneCategory(id);\n      }\n    catch (err) {\n      console.log(err);\n    }\n    try {\n      this.categories = await this.myCategoriesService.getAllCategories();\n    }\n    catch (err) {\n      console.log(err);\n    }\n  }\n\n  async openDialog() {\n    this.user = store.getState().authState.user;\n    if (this.user.admin === true) {\n    } else {\n      try {\n        this.carts = await this.myCartsService.getAllCarts(this.user._id);\n      }\n      catch (err) {\n        console.log(\"err getting user carts\");\n      }\n      console.log('The dialog was closed');\n      \n      let dialogRef = this.dialog.open(DialogComponent, {\n        data: {quantity: this.quantity, product: this.product},\n      });\n\n      dialogRef.afterClosed().subscribe( async result => {\n        this.quantity = result;\n        // find out if user have an open cart or not\n        if (this.carts === undefined || this.carts === null){\n          console.log(\"carts null\");\n          // there is no cart for this user-create one\n          this.createCartAndAddItem();\n        } else {\n          try {\n            this.orders = await this.myOrdersService.getAllUserOrders(this.user._id);\n          }\n          catch (err) {\n            console.log(\"err getting user orders\");\n          }\n          // find out if user have some old order\n          if (this.orders === undefined || this.orders === null) {\n            // there is an open cart for this user, but no orders in it-add items to it\n            this.addItemToOpenCart();\n          } else {\n            // this user have cart and order, check if he has an open cart or not\n            this.lastCartIndex = this.carts.length - 1;\n            this.lastOrderIndex = this.orders.length - 1;\n            if (this.carts[this.lastCartIndex]._id === this.orders[this.lastOrderIndex].cart._id) {\n              // the user closed his last cart-create new one for him\n              this.createCartAndAddItem(); \n            } else {\n              console.log(\"there is an open cart\")\n              this.lastCartIndex = this.carts.length - 1;\n              this.item.cart = this.carts[this.lastCartIndex];\n              // add item to user's new cart\n              this.addItemToOpenCart();\n            }\n          }\n        }\n      });\n    }\n  }\n\n  async createCartAndAddItem() {\n    this.user = store.getState().authState.user;\n    this.newCart = new CartModel();\n    this.newCart.user = this.user;\n    this.newCart.date = new Date().toDateString();\n    try {\n      this.newCart = await this.myCartsService.addCart(this.newCart);\n    }\n    catch (err) {\n      console.log(\"problem creating cart\");\n    }\n    this.item = new ItemModel();\n    this.item.cart = this.newCart;\n    this.item.product = this.product;\n    this.item.quantity = this.quantity;\n    this.item.price = this.product.price*this.quantity;\n    try {\n      this.item = await this.myItemsService.addItem(this.item);\n      this.myProductsService.updateCart(true);\n    }\n    catch (err) {\n      console.log(\"problem adding item to cart\");\n    }\n  }\n\n  async addItemToOpenCart() {\n    this.item = new ItemModel();\n    this.lastCartIndex = this.carts.length -1;\n    this.item.cart = this.carts[this.lastCartIndex];\n    this.item.product = this.product;\n    this.item.quantity = this.quantity;\n    this.item.price = this.product.price*this.quantity;\n    try {\n      this.item = await this.myItemsService.addItem(this.item);\n      this.myProductsService.updateCart(true);\n    }\n    catch (err) {\n      console.log(\"problem adding item to cart\");\n    }\n  }\n}\n\n\n","<div mat-raised-button (click)=\"openDialog()\">\n    {{product.name}}\n    <br />\n    Price: {{product.price}}\n    <br />\n    <img [src]=\"imageUrl + product.imageName\"/>\n</div>\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}